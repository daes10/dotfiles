---
- name: Update, upgrade and install apt packages on desktop host
  hosts: localhost
  become: true
  gather_facts: true
  vars:
    # packages within the default apt repo
    standard_pkgs:
      - vim
      - git
      - curl
      - atop
      - bleachbit
      - diffutils
      - flameshot
      - flatpak
      - gnome-shell-extension-manager
      - gnome-software-plugin-flatpak
      - gnome-software-plugin-snap
      - gnome-tweaks
      - gufw
      - neovim
      - ntpdate
      - pipx
      - preload
      - ripgrep
      - synaptic
      - timeshift
      - xclip
      - zsh
      - fzf
      - neofetch
      - starship

    # packages from special repos
    special_pkgs:
      - gnome-shell-extension-manager

    # packages from external repos
    external_pkgs:
      - proton-mail

  tasks:
    - name: Get my user
      ansible.builtin.set_fact:
        remote_regular_user: "{{ ansible_env.SUDO_USER or ansible_user_id }}"
        remote_user_home: "/home/{{ ansible_env.SUDO_USER or ansible_user_id }}"

    - name: Update apt package index
      ansible.builtin.apt:
        update_cache: true

    - name: Upgrade all apt packages
      ansible.builtin.apt:
        upgrade: true

    - name: Clean up apt cache
      ansible.builtin.apt:
        autoclean: false
        autoremove: false

    - name: Install standard packages
      ansible.builtin.apt:
        name: "{{ standard_pkgs }}"
        state: present

    - name: Change shell to zsh
      ansible.builtin.user:
        name: "{{ remote_regular_user }}"
        shell: /usr/bin/zsh

    - name: Ensure fonts directory
      ansible.builtin.file:
        path: "{{ remote_user_home }}/.local/share/fonts"
        state: directory
        mode: "0755"
        owner: "{{ remote_regular_user }}"

    - name: Check if FiraCode font already exists
      ansible.builtin.stat:
        path: "{{ remote_user_home }}/.local/share/fonts/FiraCode"
      register: firacode_font_exists

    - name: Ensure FiraCode font directory, if FiraCode not exists
      when: not firacode_font_exists.stat.exists
      ansible.builtin.file:
        path: "{{ remote_user_home }}/.local/share/fonts/FiraCode"
        state: directory
        mode: "0755"
        owner: "{{ remote_regular_user }}"

    - name: Download FiraCode Nerd Font
      when: not firacode_font_exists.stat.exists
      ansible.builtin.unarchive:
        src: https://github.com/ryanoasis/nerd-fonts/releases/download/v3.4.0/FiraCode.zip
        dest: "{{ remote_user_home }}/.local/share/fonts/FiraCode"
        remote_src: true
        mode: "0755"
        owner: "{{ remote_regular_user }}"

    - name: Refresh font cache
      command: fc-cache -fv
      changed_when: false

    - name: Install Warp .deb package
      block:
        - name: Gather package facts
          ansible.builtin.package_facts:
            manager: apt

        - name: Ensure local installer folder exists
          ansible.builtin.file:
            path: "{{ ansible_env.HOME }}/.local/share/installers"
            state: directory
            mode: '0755'

        - name: Download Warp .deb package for future use
          ansible.builtin.get_url:
            url: https://app.warp.dev/download?package=deb
            dest: "{{ ansible_env.HOME }}/.local/share/installers/warp-terminal.deb"
            mode: '0644'
            force: yes

        - name: Install Warp terminal if not already installed
          become: true
          ansible.builtin.apt:
            deb: "{{ ansible_env.HOME }}/.local/share/installers/warp-terminal.deb"
          when: "'warp-terminal' not in ansible_facts.packages"   

    - name: Install Brave Browser and release-channel
      block:
        - name: Gather package facts
          ansible.builtin.package_facts:
            manager: apt

        - name: Add Brave GPG key
          ansible.builtin.get_url:
            url: https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg
            dest: /usr/share/keyrings/brave-browser-archive-keyring.gpg
            mode: '0644'
        
        - name: Add Brave APT repository (Release channel)
          ansible.builtin.apt_repository:
            repo: "deb [signed-by=/usr/share/keyrings/brave-browser-archive-keyring.gpg] https://brave-browser-apt-release.s3.brave.com/ stable main"
            state: present
            filename: brave-browser-release
        
        - name: Update apt cache
          ansible.builtin.apt:
            update_cache: true
        
        - name: Install Brave Browser
          ansible.builtin.apt:
            name: brave-browser
            state: present

